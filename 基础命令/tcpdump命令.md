# tcpdump命令

使用tcpdump抓包，首先大部分命令需要sudo开头，或者转换root用户

```bash
sudo tcpdump -D
```

列出可以抓包的网络接口

其中特殊接口 `any` 可用于抓取所有活动的网络接口的数据包。



那就用如下命令先对 `any `接口进行抓包实验：

```bash
sudo tcpdump -i any
```

这个时候`tcpdump`会持续抓包直到收到中断信号。可以按`ctrl+c`停止抓包

`tcpdump` 会抓取ssh连接到服务器的包，所以ssh的话会一直捕获数据包。

`-c` 选项可以限制 `tcpdump` 抓包的数量：

```bash
sudo tcpdump -i any -c 5
```

如上所示，`tcpdump` 在抓取 5 个数据包后自动停止了抓包。

这在有些场景中十分有用 —— 比如你只需要抓取少量的数据包用于分析。

当我们需要使用过滤规则抓取特定的数据包（如下所示）时，`-c` 的作用就十分突出了。



在上面示例中，`tcpdump` 默认是将IP地址和端口号解析为对应的接口名以及服务协议名称。

而通常在网络故障排查中，使用IP地址和端口号更便于分析问题；

用 `-n` 选项显示IP地址， `-nn`选项显示端口号

```bash
sudo tcpdump -i any -c5 -nn
```

抓取数据包显示IP地址和端口号。还可以组织`tcpdump`发出DNS查找，有助于在网络故障排查中减少数据流量。



**理解抓取报文**

首先`tcpdump`能够抓取并解码多种协议类型的数据报文，如`TCP` `UDP	` `ICMP`等等。

主要分析TCP类型的数据报文，入门简单。更多有关`tcpdump`的详细介绍可以参考

http://www.tcpdump.org/manpages/tcpdump.1.html#lbAG



`tcpdump` 抓取的TCP报文看起来如下：

```bash
08:41:13.729687 IP 192.168.64.28.22``>``192.168.64.1.41916:``Flags``[P.], seq 196:568, ack 1, win 309, options [nop,nop,TS val 117964079 ecr 816509256], length 372
```

具体字段根据不同的报文类型会有不同，但上面这个例子是一般的格式形式。

第一个字段 `08:41:13.729687` 是该数据报文被抓取时的系统本地时间戳

第二个字段，`IP` 是网络层协议类型，这里是 `IPv4` ，如果是 `IPv6` 协议，该字段值是 `IP6`

`192.168.64.28.22` 是源ip地址和端口号，紧跟着后的是目的ip地址和其端口号，这里是`192.168.64.1.41916` 

第三个字段，在源IP和目的IP之后，可以看到是TCP报文标记段 `Flags [P.]` 该字段通常取值如下：

值标志类型描述

`SSYNConnection StartFFINConnection FinishPPUSHData pushRRSTConnection reset.ACKAcknowledgment`



这字段也可以是这些值的结合，例如 `[S.]` 代表 `SYN-ACK` 数据包

接下来是该数据包中数据的序列号。对于抓取的第一个数据包，该字段值是一个绝对数字，后续包使用相对数值，以便更容易查询跟踪。例如此处 `seq 196:568` 代表该数据包包含该数据流的第196到568字节

接下来是ack值：`ack 1` 该数据包是数据发送方，ack值为1。在数据接收方，该字段代表数据流的下一个预期字节的数据。例如，该数据流中下一个数据包的`ack ` 值应该是568

接下来字段是接受窗口大小 `win 309` ，它表示接收缓冲区可用的字节数，后跟TCP选项如MSS（最大段大小）或者窗口比例值。更详尽TCP协议内容自行查看



最后 `length 372` 代表数据包有效载荷字节长度。这个长度和seq序列号中字节数值长度是不一样的



现在学习如何过滤数据报文以便更容易分析定位问题。



**过滤数据包**

正如之前所说，`tcpdump` 可以抓取很多中类型的数据报文，其中很多可能是我们需要查找的问题并没有关系。举个例子，假设正在定位一个与web服务器连接的网络问题，就不必关系SSH数据报文，因此在抓包过程中过滤掉SSH报文可能更便于你分析问题。



`tcpdump` 有很多参数选项可以设置数据包过滤规则，例如根据源IP以及目的IP地址，端口号，协议等等规则来过滤数据包。



`协议`

在命令中指定协议便可以按照协议类型来筛选数据包。比方说用如下命令之抓取ICMP报文：

```bash
sudo tcpdump -i any -c5 icmp
```

现在已经有部分结果了

然后再打开一个终端，去ping另一台机器：

```bash
ping www.alibaba.com
```

回到`tcpdump`命令终端看出它筛选了`ICMP`报文



`主机`

用`host` 参数只抓取和特定主机相关的数据包

```bash
sudo tcpdump -i any -c5 -nn host 54.204.39.132
```

如结果所示，之抓取和显示与 `54.204.39.132` 有关的数据包



`端口号`

`tcpdump` 可以根据服务类型或者端口号来筛选数据包。例如，抓取和HTTP服务相关的数据包

```bash
sudo tcpdump -i any -c55 -nn port 80
```



`IP地址/主机名`

同样，可以根据源IP地址或者目的IP地址或者主机名来筛选数据包。例如抓取源IP地址为`192.168.122.98` 的数据包

```bash
sudo tcpdump -i any -c5 -nn src 192.168.122.98
```



使用`dst` 就是按照目的IP/主机名来筛选数据包

```bash
sudo tcpdump -i any -c5 -nn dst 192.168.122.98
```



`多条件筛选`

当然可以使用多条件组合来筛选数据包，使用`and `以及`or` 逻辑操作符来创建过滤规则。例如，筛选来自源IP地址 `192.168.122.98` 的HTTP数据包

```bash
sudo tcpdump -i any -c5 -nn src 192.168.122.98  and port 80
```



也可以使用括号来创建更为复杂的过滤规则，但在shell中请用引用包含你的过滤规则以防被识别为shell表达式

```bash
sudo tcpdump -i any -c5 -nn "port 80 and (src 192.168.122.98 or src 192.168.122.97)"
```



该例子中我们只抓取了来自源 IP 为 `192.168.122.98` 或者 `54.204.39.132` 的 HTTP （端口号80）的数据包。使用该方法就很容易抓取到数据流中交互双方的数据包了。



**检查数据包内容**

在以上实例中，只按数据包头部的信息来建立规则筛选数据包，例如源地址、目的地址、端口号等。有时需要分析网络连接问题，可能需要分析数据包中内容来判断什么内容需要被发送、什么内容需要被接收等。`tcpdump `提供两个选项可以查看数据包内容，`-X`以十六进制打印出数据报文内容，`-A`打印数据报文的ASCII值

```bash
sudo tcpdump -i any -c10 -nn -A port 80
```

![image-20210625004951060](C:\Users\10505\AppData\Roaming\Typora\typora-user-images\image-20210625004951060.png)

这对定位一些普通HTTP调用API接口的问题有用。当然如果是加密包问，这个输出也就没多大用了。



**保存抓包数据**

`tcpdump` 提供了保存抓包数据的功能以便后续分析数据包。例如，你可以夜里让他在那里抓包，早上再去分析它。同样当有很多数据包时，显示过快也不利于分析，将数据包保存下来，更有利于分析问题。



使用`-w` 选项来保存数据包而不是在屏幕上显示出抓取的数据包

```bash
sudo tcpdump -i any -c10 -nn -w webserver.pcap port 80
```

![image-20210625005255792](C:\Users\10505\AppData\Roaming\Typora\typora-user-images\image-20210625005255792.png)

该命令将抓取的数据包保存到文件`webserver.pcap`。后缀名`pcap`表示文件是抓取的数据包格式



正如实例中该命令保存数据包到文件中时，屏幕没有显示任何有关数据报文的输出，其中-c10表示抓取到10个数据包就停止抓包。如果想有一些反馈来提示的确抓取到了数据包，可以用 `-v`选项。

`tcpdump`将数据包保存在二进制文件中，所以不能简单用文本编辑器去打开它。使用`-r`选项参数来阅读该文件的报文内容：

```bash
tcpdump -nn -r webserver.pcap
```

这里不需要管理员权限 `sudo` 了，因为此刻并不是在网络接口处抓包。

你还可以使用我们讨论过的任何过滤规则来过滤文件中的内容，就像使用实时数据一样。 例如，通过执行以下命令从源 IP 地址 `54.204.39.132` 检查文件中的数据包：

```bash
tcpdump-nn -r webserver.pcap src 54.204.39.132
```



以上的基本功能已经可以帮助你使用强大的 `tcpdump` 抓包工具了。更多的内容请参考 [tcpdump 网站](https://link.zhihu.com/?target=http%3A//www.tcpdump.org/%23) 以及它的 [帮助文件](https://link.zhihu.com/?target=http%3A//www.tcpdump.org/manpages/tcpdump.1.html)。





Wireshark 还可以用来读取 `tcpdump` 保存的 pcap 文件。你可以使用 `tcpdump` 命令行在没有 GUI 界面的远程机器上抓包然后在 Wireshark 中分析数据包。



# Wireshark命令

 





















