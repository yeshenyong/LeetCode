# gdb 实战踩坑

### core 仿场景代码

```cpp
#include <iostream>
#include <vector>
#include <unordered_map>
#include <list>

using namespace std;

void gdb_method_one() {
    unordered_map<string, string> mymap = {
        {"ysy", "22"},
        {"hzy", "21"}
    };
    vector<string> myvec = {"22", "21"};

    char* ptr = nullptr;
    *ptr = 0;
    return;
}

int main() {

    int gdb_1 = 1;

    gdb_method_one();

    string gdb_2 = "ysy";

    return 0;
}
```



基本语法：

> gdb 可执行文件 core.file



### core 文件生成

```sh
root@iZwz9i5zftiq15tkzdk682Z:~/cpp_/unix/practice_cpp/coredump_test/build# ulimit -c unlimited
root@iZwz9i5zftiq15tkzdk682Z:~/cpp_/unix/practice_cpp/coredump_test/build# ulimit -c
unlimited
root@iZwz9i5zftiq15tkzdk682Z:~/cpp_/unix/practice_cpp/coredump_test/build# ./a.out 
Segmentation fault (core dumped)
```



### bt 调试

```sh
root@iZwz9i5zftiq15tkzdk682Z:~/cpp_/unix/practice_cpp/coredump_test# gdb a.out core 
GNU gdb (Ubuntu 8.1.1-0ubuntu1) 8.1.1
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from a.out...done.
[New LWP 12112]
Core was generated by `./a.out'.
Program terminated with signal SIGSEGV, Segmentation fault.
---Type <return> to continue, or q <return> to quit---
#0  0x0000564cfedb125b in gdb_method_one () at main.cc:16
16          *ptr = 0;
(gdb) bt
#0  0x0000564cfedb125b in gdb_method_one () at main.cc:16
#1  0x0000564cfedb1392 in main () at main.cc:24
(gdb) bt -1
#1  0x0000564cfedb1392 in main () at main.cc:24
(gdb) 
```

可以看到，core 的位置相当明确，在`gdb_method_one` 里，`main.cc` 的16行对内存进行了非法访问



### up 调试

### down 调试

堆栈上下移动

```sh
(gdb) up 1
#1  0x0000564cfedb1392 in main () at main.cc:24
24          gdb_method_one();
(gdb) up 1
#1  0x0000564cfedb1392 in main () at main.cc:24
24          gdb_method_one();
(gdb) down 1
#0  0x0000564cfedb125b in gdb_method_one () at main.cc:16
16          *ptr = 0;
(gdb) up 1
#1  0x0000564cfedb1392 in main () at main.cc:24
24          gdb_method_one();
(gdb) p gdb_1
$5 = 1
(gdb) p gdb_2
$6 = ""
```



### 问题

1. No [symbol](https://so.csdn.net/so/search?q=symbol&spm=1001.2101.3001.7020) "var" in current context.

   解法

   1. 关掉优化 GNU 的C/C++编译器

      在编译是加入 ‘-gstabs+’  选项，比如:

      g++ -g -Wall  -gstabs+ -o main.o main.cpp

2. 



### stl 打印

#### vector

#### unordered_map

#### list

#### string

原

```sh
(gdb) p mymap
$1 = {
  _M_h = {<_Hashtable_base> = {<_Hash_code_base> = {<_Hashtable_ebo_helper> = {<_Select1st> = {<No data fields>}, <No data fields>}, <_Hashtable_ebo_helper> = {<hash> = {<__hash_base> = {<No data fields>}, <No data fields>}, <No data fields>}, <_Hashtable_ebo_helper> = {<_Mod_range_hashing> = {<No data fields>}, <No data fields>}, <No data fields>}, <_Hashtable_ebo_helper> = {<equal_to> = {<binary_function> = {<No data fields>}, <No data fields>}, <No data fields>}, <No data fields>}, <_Map_base> = {<No data fields>}, <_Insert> = {<_Insert_base> = {<No data fields>}, <No data fields>}, <_Rehash_base> = {<No data fields>}, <_Equality> = {<No data fields>}, <_Hashtable_alloc> = {<_Hashtable_ebo_helper> = {<allocator> = {<new_allocator> = {<No data fields>}, <No data fields>}, <No data fields>}, <No data fields>}, _M_buckets = 0x0, _M_bucket_count = 12790461807862340608, _M_before_begin = {_M_nxt = 0x7ffc89715b40}, _M_element_count = 2, _M_rehash_policy = {static _S_growth_factor = <optimized out>, _M_max_load_factor = 1.80066853e-41, 
      _M_next_resize = 140453855636224}, _M_single_bucket = 0x7ffc89715b60}}
(gdb) p myvec
$2 = {<_Vector_base> = {_M_impl = {<allocator> = {<new_allocator> = {<No data fields>}, <No data fields>}, _M_start = 0x56356b009ef0, _M_finish = 0x2, _M_end_of_storage = 0x7fbd3f800000}}, <No data fields>}

(gdb) p mymap["ysy"]
Could not find operator[].
(gdb) p mymap.find("ysy")
Cannot evaluate function -- may be inlined
```



好看一点

```sh
(gdb) p *(myvec._M_impl._M_start)@2
$6 = {{static npos = 18446744073709551615, _M_dataplus = {<allocator> = {<new_allocator> = {<No data fields>}, <No data fields>}, _M_p = 0x56356b009e90 ""}, _M_string_length = 94787428458248, {_M_local_buf = "\003\000\000\000\000\000\000\000hzy\000\000\000\000", 
      _M_allocated_capacity = 3}}, {static npos = 18446744073709551615, _M_dataplus = {<allocator> = {<new_allocator> = {<No data fields>}, <No data fields>}, _M_p = 0x0}, _M_string_length = 94787428458280, {
      _M_local_buf = "\002\000\000\000\000\000\000\000\062\061\000\000\000\000\000", _M_allocated_capacity = 2}}}
(gdb) p *(myvec._M_impl._M_start)@1
$7 = {{static npos = 18446744073709551615, _M_dataplus = {<allocator> = {<new_allocator> = {<No data fields>}, <No data fields>}, _M_p = 0x56356b009e90 ""}, _M_string_length = 94787428458248, {_M_local_buf = "\003\000\000\000\000\000\000\000hzy\000\000\000\000", 
      _M_allocated_capacity = 3}}}
```



最好还是使用配置文件

https://www.cnblogs.com/silentnight/p/5466418.html